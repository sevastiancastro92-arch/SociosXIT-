<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | SociosXIT</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script> 
    
    <script src="https://sevastiancastro92-arch.github.io/Pruevafirebase/firebaseconfig.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155', 600: '#475569' },
                        brand: { cyan: '#06B6D4', green: '#10B981', yellow: '#FBBF24', pink: '#EC4899', purple: '#8B5CF6' }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0f172a;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                              radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%);
            color: #f1f5f9;
            min-height: 100vh;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .step-hidden { display: none !important; }
        .step-active { display: block !important; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .payment-format {
            white-space: pre-wrap;
            font-size: 11px;
            font-family: monospace;
            background-color: #0f172a; 
            border: 1px solid #334155; 
            padding: 12px;
            border-radius: 8px;
            color: #f1f5f9; 
            overflow-x: auto;
        }
    </style>
</head>
<body class="p-4 md:p-6 flex justify-center items-start pt-6">

    <div class="w-full max-w-4xl space-y-8">
        
        <div class="glass-panel p-6 rounded-3xl shadow-2xl relative overflow-hidden border border-slate-700/50">
            <div class="absolute top-4 left-6 flex items-center gap-2">
                <div class="h-2 w-2 bg-brand-green rounded-full animate-pulse"></div>
                <p class="text-[10px] md:text-xs font-mono uppercase tracking-wider">
                    <span class="text-slate-400">ID:</span> <span id="userDisplay" class="text-brand-cyan">Cargando...</span>
                    <span class="mx-2 text-slate-700">|</span>
                    <span class="text-slate-400">Balance:</span> <span id="userBalance" class="text-white font-bold">$0.00</span>
                </p>
            </div>

            <div class="text-center mb-6 mt-10 md:mt-4">
                <h1 class="text-xl md:text-2xl font-black text-white flex items-center justify-center gap-2 tracking-tighter">
                    <i class="fa-solid fa-wallet text-brand-green"></i> MI BILLETERA VIRTUAL
                </h1>
                <p class="text-[10px] text-brand-cyan font-bold tracking-[0.2em] uppercase">SociosXIT Internacional</p>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <button onclick="openModal()" class="group bg-gradient-to-br from-brand-green to-emerald-700 p-4 rounded-2xl transition-all transform hover:scale-[1.02] active:scale-95 shadow-[0_10px_20px_rgba(16,185,129,0.2)]">
                    <i class="fa-solid fa-circle-plus text-2xl mb-1 group-hover:rotate-90 transition-transform"></i>
                    <span class="block font-bold text-sm">Recargar</span>
                </button>
                <button class="bg-dark-800/50 border border-slate-700 p-4 rounded-2xl opacity-50 cursor-not-allowed">
                    <i class="fa-solid fa-building-columns text-2xl mb-1 text-slate-500"></i>
                    <span class="block font-bold text-sm text-slate-500">Retirar</span>
                </button>
            </div>

            <div class="flex flex-col md:flex-row gap-3">
                <button onclick="document.getElementById('historySection').scrollIntoView({behavior: 'smooth'})" class="flex-1 bg-slate-800 hover:bg-slate-700 py-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2 transition-colors">
                    <i class="fa-solid fa-clock-rotate-left"></i> Historial
                </button>
                <button onclick="cerrarSesion()" class="flex-1 bg-red-500/10 hover:bg-red-500/20 text-red-500 py-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2 transition-colors">
                    <i class="fa-solid fa-power-off"></i> Salir de la Cuenta
                </button>
            </div>
        </div>

        <div id="historySection" class="space-y-4">
            <h2 class="text-sm font-black text-slate-500 uppercase tracking-[0.3em] pl-2 flex items-center gap-2">
                <div class="h-px w-8 bg-slate-700"></div> Movimientos Recientes
            </h2>
            <div id="historyGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="emptyState" class="hidden text-center py-12 glass-panel rounded-3xl">
                <i class="fa-solid fa-receipt text-4xl text-slate-700 mb-2"></i>
                <p class="text-slate-500 text-sm">No hay transacciones a칰n</p>
            </div>
        </div>
    </div>

    <div id="mainModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
        <div class="bg-dark-800 border border-slate-700 w-full max-w-sm rounded-3xl shadow-2xl relative overflow-hidden">
            
            <div id="step1" class="step-active p-6">
                <h3 class="text-center font-bold mb-4">Selecciona tu Pa칤s</h3>
                <div class="grid grid-cols-2 gap-2 max-h-80 overflow-y-auto pr-2 custom-scrollbar" id="countryGrid"></div>
            </div>

            <div id="step2" class="step-hidden p-8 text-center">
                <div class="text-5xl mb-4" id="selectedFlag"></div>
                <h3 class="font-bold text-white mb-6">쮺u치nto deseas recargar?</h3>
                <div class="bg-dark-900 p-4 rounded-2xl border border-slate-700 mb-6">
                    <div class="flex items-center justify-center text-3xl font-black text-brand-cyan">
                        <span class="mr-1">$</span>
                        <input type="number" id="amountInput" class="bg-transparent w-24 outline-none text-center" placeholder="0">
                        <span class="text-sm ml-2 text-slate-500">USD</span>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-800 flex justify-between text-xs font-mono">
                        <span class="text-slate-500">Recibir치s:</span>
                        <span id="localAmountPreview" class="text-brand-yellow">--</span>
                    </div>
                </div>
                <button onclick="createOrder()" id="btnGenerate" disabled class="w-full bg-brand-cyan text-dark-900 font-black py-4 rounded-2xl disabled:opacity-20 shadow-lg shadow-brand-cyan/20">GENERAR ORDEN</button>
                <button onclick="changeStep(1)" class="mt-4 text-xs text-slate-500 font-bold hover:text-white transition-colors">VOLVER</button>
            </div>

            <div id="step3" class="step-hidden">
                <div class="bg-brand-green p-4 text-dark-900 flex justify-between items-center font-black text-xs">
                    <span>ORDEN GENERADA</span>
                    <span id="ticketId">#000000</span>
                </div>
                <div class="p-6">
                    <pre id="formattedPaymentDetails" class="payment-format mb-4 custom-scrollbar max-h-60"></pre>
                    <button id="copyAllDetailsBtn" class="w-full bg-slate-700 py-3 rounded-xl font-bold text-xs mb-2">COPIAR DATOS</button>
                    <button onclick="closeModal()" class="w-full py-3 text-xs text-slate-500 font-bold">ENTENDIDO</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- LOGICA DE FIREBASE ---
        const auth = firebase.auth();
        const db = firebase.database();

        function sanitize(email) { return email ? email.replace(/\./g, '_') : null; }

        // Verificar Sesi칩n al Cargar
        auth.onAuthStateChanged((user) => {
            const display = document.getElementById("userDisplay");
            const balanceText = document.getElementById("userBalance");

            if (user) {
                const safeEmail = sanitize(user.email);
                display.innerText = user.email.split('@')[0];

                // Escuchar saldo en TIEMPO REAL
                db.ref(`users/${safeEmail}/balance`).on('value', (snap) => {
                    const val = snap.val() || 0;
                    balanceText.innerText = `$${parseFloat(val).toFixed(2)} USD`;
                });

                renderHistory();
            } else {
                // Si no hay sesi칩n, esperar 2 segundos y redirigir
                display.innerText = "Sin Sesi칩n...";
                setTimeout(() => { if(!auth.currentUser) window.location.href = 'index.html'; }, 2000);
            }
        });

        function cerrarSesion() {
            auth.signOut().then(() => window.location.href = 'index.html');
        }

        // --- L칍GICA DE LA BILLETERA ---
        const EXCHANGE_DATA = {
            COL: { name: "Colombia", flag: "游뻟릖", currency: "COP", rate: 3800, methods: "Nequi: 3214701288\nBancolombia: 76900007797" },
            MEX: { name: "M칠xico", flag: "游쓇릖", currency: "MXN", rate: 20, methods: "OXXO/Nu: 5101250686919389" },
            PER: { name: "Per칰", flag: "游왫릖", currency: "PEN", rate: 3.8, methods: "Yape/Plin: 954302258" },
            USA: { name: "USA", flag: "游쥟릖", currency: "USD", rate: 1, methods: "Zelle: +1 (754) 317-1482" },
            VEN: { name: "Venezuela", flag: "游游", currency: "VES", rate: 350, methods: "Pago M칩vil: 0102-04128975265-V31303430" }
        };

        let state = { country: null, usd: 0 };

        function renderCountryGrid() {
            const grid = document.getElementById('countryGrid');
            Object.keys(EXCHANGE_DATA).forEach(key => {
                const c = EXCHANGE_DATA[key];
                const btn = document.createElement('button');
                btn.className = "bg-dark-700/50 border border-slate-700 p-3 rounded-xl flex items-center gap-2 hover:bg-brand-cyan hover:text-dark-900 transition-all font-bold text-[10px]";
                btn.onclick = () => { state.country = key; document.getElementById('selectedFlag').innerText = c.flag; changeStep(2); };
                btn.innerHTML = `<span>${c.flag}</span> <span>${c.name}</span>`;
                grid.appendChild(btn);
            });
        }

        document.getElementById('amountInput').oninput = (e) => {
            const val = parseFloat(e.target.value);
            const btn = document.getElementById('btnGenerate');
            if(val >= 3) {
                state.usd = val;
                const local = val * EXCHANGE_DATA[state.country].rate;
                document.getElementById('localAmountPreview').innerText = `${local.toLocaleString()} ${EXCHANGE_DATA[state.country].currency}`;
                btn.disabled = false;
            } else {
                btn.disabled = true;
                document.getElementById('localAmountPreview').innerText = "--";
            }
        };

        function createOrder() {
            const id = Math.floor(100000 + Math.random() * 900000);
            const c = EXCHANGE_DATA[state.country];
            const totalLocal = (state.usd * c.rate).toLocaleString();
            
            const order = {
                id, date: new Date().toLocaleDateString(),
                flag: c.flag, country: c.name,
                usd: state.usd, local: `${totalLocal} ${c.currency}`
            };

            // Guardar localmente
            const orders = JSON.parse(localStorage.getItem('my_orders') || '[]');
            orders.unshift(order);
            localStorage.setItem('my_orders', JSON.stringify(orders));

            // Mostrar Ticket
            document.getElementById('ticketId').innerText = `#${id}`;
            document.getElementById('formattedPaymentDetails').innerText = 
                `游눯 PAGO PENDIENTE\n\n` +
                `ID: #${id}\n` +
                `Monto: ${order.local}\n\n` +
                `DATOS DE DEP칍SITO:\n${c.methods}\n\n` +
                `丘멆잺 Env칤a captura al soporte una vez realizado.`;
            
            changeStep(3);
            renderHistory();
        }

        function renderHistory() {
            const orders = JSON.parse(localStorage.getItem('my_orders') || '[]');
            const grid = document.getElementById('historyGrid');
            const empty = document.getElementById('emptyState');
            grid.innerHTML = "";
            
            if(orders.length === 0) { empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');

            orders.forEach(o => {
                const div = document.createElement('div');
                div.className = "glass-panel p-4 rounded-2xl border border-slate-800 text-xs";
                div.innerHTML = `
                    <div class="flex justify-between mb-2">
                        <span class="text-slate-500">#${o.id}</span>
                        <span class="text-brand-yellow font-bold">Pendiente</span>
                    </div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-xl">${o.flag}</span>
                        <span class="font-bold">${o.local}</span>
                    </div>
                    <div class="text-[10px] text-slate-500">${o.date}</div>
                `;
                grid.appendChild(div);
            });
        }

        function changeStep(n) {
            [1,2,3].forEach(i => document.getElementById(`step${i}`).className = i === n ? 'step-active' : 'step-hidden');
        }

        function openModal() { document.getElementById('mainModal').classList.remove('hidden'); changeStep(1); }
        function closeModal() { document.getElementById('mainModal').classList.add('hidden'); }

        renderCountryGrid();
    </script>
</body>
</html>
