<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editar Perfil y Seguridad</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <!-- Tu config Firebase DIRECTO -->
    <script>
      const firebaseConfig = {
    apiKey: "AIzaSyCr1-2dIqgxoXBTKYgSusnUZorUICX2Too",
    authDomain: "chatglobal-e9370.firebaseapp.com",
    databaseURL: "https://chatglobal-e9370-default-rtdb.firebaseio.com",
    projectId: "chatglobal-e9370",
    storageBucket: "chatglobal-e9370.firebasestorage.app",
    messagingSenderId: "382420208590",
    appId: "1:382420208590:web:9425fa28c8cdf669adb99f"
};

// Inicializar Firebase si no est√° iniciado
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const database = firebase.database();
      const usersRef = database.ref("users");
    </script>

    <!-- Estilos internos (soluciona el fondo negro) -->
    <style>
        body {
            margin: 0;
            background: #000;
            color: white;
            overflow-x: hidden;
        }

        /* EL CANVAS SIEMPRE DETR√ÅS */
        #particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0 !important;
            pointer-events: none;
        }

        /* EL CONTENIDO SIEMPRE ENCIMA */
        .app-root {
            position: relative;
            z-index: 10 !important;
        }

        .card {
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(6px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .neon-btn {
            background: linear-gradient(90deg, #ff00c8, #00c3ff);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            transition: 0.25s;
        }

        .neon-btn:hover {
            filter: brightness(1.2);
        }
    </style>
</head>

<body class="p-4 md:p-8 text-white">

    <!-- FONDO DE PART√çCULAS -->
    <canvas id="particles"></canvas>

    <div class="app-root">
        <div class="max-w-xl mx-auto mt-6">

            <a href="dashboard.html"
                class="flex items-center text-sm font-medium text-cyan-300 hover:text-white transition duration-200 mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                    fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round" class="mr-1">
                    <path d="m15 18-6-6 6-6" />
                </svg>
                Volver al Dashboard
            </a>

            <h1 class="text-3xl md:text-4xl font-extrabold mb-8 text-pink-400 drop-shadow-lg">
                üîß Ajustes de Perfil
            </h1>

            <div id="statusMessage" class="hidden p-4 rounded-lg mb-4 font-semibold"></div>

            <!-- Editar Nombre -->
            <div class="card rounded-xl p-6 mb-8">
                <h2 class="text-2xl font-bold mb-4 text-cyan-300">
                    Editar Nombre de Usuario
                </h2>

                <form id="updateUsernameForm" class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400">Nombre Actual</label>
                        <input id="currentUsername" readonly
                            class="mt-1 block w-full px-4 py-3 rounded-lg bg-gray-700 text-gray-400 border border-gray-600">
                    </div>

                    <div>
                        <label class="block text-sm text-gray-400">Nuevo Nombre</label>
                        <input id="newUsername"
                            class="mt-1 block w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-600 focus:ring-2 focus:ring-cyan-300">
                    </div>

                    <button class="neon-btn w-full">Actualizar Nombre</button>
                </form>
            </div>

            <!-- Cambiar Contrase√±a -->
            <div id="changePasswordCard" class="card rounded-xl p-6">
                <h2 class="text-2xl font-bold mb-4 text-pink-400">Cambiar Contrase√±a</h2>

                <form id="changePasswordForm" class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400">Contrase√±a Actual</label>
                        <input id="currentPassword" type="password" required
                            class="mt-1 block w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-600">
                    </div>

                    <div>
                        <label class="block text-sm text-gray-400">Nueva Contrase√±a</label>
                        <input id="newPassword" type="password" required
                            class="mt-1 block w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-600">
                    </div>

                    <div>
                        <label class="block text-sm text-gray-400">Confirmar</label>
                        <input id="confirmPassword" type="password" required
                            class="mt-1 block w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-600">
                    </div>

                    <button class="neon-btn w-full">Actualizar Contrase√±a</button>
                </form>
            </div>

        </div>
    </div>

    <!-- SCRIPT DE PART√çCULAS (100% funcionando) -->
    <script>
        const canvas = document.getElementById("particles");
        const ctx = canvas.getContext("2d");
        let particlesArray = [];
        let w, h;

        function initCanvas() {
            w = canvas.width = window.innerWidth;
            h = canvas.height = window.innerHeight;
        }

        window.addEventListener("resize", initCanvas);
        initCanvas();

        class Particle {
            constructor() {
                this.x = Math.random() * w;
                this.y = Math.random() * h;
                this.size = Math.random() * 2 + 1;
                this.speedX = (Math.random() - 0.5) * 0.7;
                this.speedY = (Math.random() - 0.5) * 0.7;
            }
            update() {
                this.x += this.speedX;
                this.y += this.speedY;

                if (this.x < 0 || this.x > w) this.speedX *= -1;
                if (this.y < 0 || this.y > h) this.speedY *= -1;
            }
            draw() {
                ctx.fillStyle = "rgba(0,255,255,0.7)";
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function initParticles() {
            particlesArray = [];
            for (let i = 0; i < 130; i++) particlesArray.push(new Particle());
        }
        initParticles();

        function animate() {
            ctx.clearRect(0, 0, w, h);
            particlesArray.forEach(p => {
                p.update();
                p.draw();
            });
            requestAnimationFrame(animate);
        }
        animate();
    </script>

    <!-- L√ìGICA FIREBASE (exactamente igual que la tuya) -->
    <script>
        const currentUsernameInput = document.getElementById('currentUsername');
        const newUsernameInput = document.getElementById('newUsername');
        const updateUsernameForm = document.getElementById('updateUsernameForm');
        const changePasswordForm = document.getElementById('changePasswordForm');
        const changePasswordCard = document.getElementById('changePasswordCard');
        const currentPasswordInput = document.getElementById('currentPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const statusMessage = document.getElementById('statusMessage');

        let currentUser = null;

        const sessionUser = sessionStorage.getItem("sociosxit_user");
        if (!sessionUser) location.href = "index.html";
        else currentUsernameInput.value = sessionUser;

        function displayStatus(msg, ok = true) {
            statusMessage.textContent = msg;
            statusMessage.className = `p-4 rounded-lg mb-4 font-semibold ${ok ? "bg-green-700" : "bg-red-700"}`;
            statusMessage.classList.remove("hidden");
            setTimeout(() => statusMessage.classList.add("hidden"), 5000);
        }

        auth.onAuthStateChanged(async user => {
            if (!user) return location.href = "index.html";
            currentUser = user;

            const snap = await usersRef.child(sessionUser).once("value");
            const userData = snap.val();

            if (!userData || !userData.password) changePasswordCard.style.display = "none";
        });

        updateUsernameForm.addEventListener("submit", async e => {
            e.preventDefault();
            const newName = newUsernameInput.value.trim();
            const oldName = sessionStorage.getItem("sociosxit_user");

            if (newName.length < 3) return displayStatus("M√≠nimo 3 caracteres", false);

            const exists = await usersRef.child(newName).once("value");
            if (exists.exists()) return displayStatus("Nombre ya en uso", false);

            const oldData = (await usersRef.child(oldName).once("value")).val();

            oldData.name = newName;

            await usersRef.child(newName).set(oldData);
            await usersRef.child(oldName).remove();

            await currentUser.updateProfile({ displayName: newName });

            sessionStorage.setItem("sociosxit_user", newName);
            currentUsernameInput.value = newName;
            newUsernameInput.value = "";

            displayStatus("Nombre actualizado ‚úî");
        });

        changePasswordForm.addEventListener("submit", async e => {
            e.preventDefault();

            const old = currentPasswordInput.value;
            const n1 = newPasswordInput.value;
            const n2 = confirmPasswordInput.value;

            if (n1 !== n2) return displayStatus("Las contrase√±as no coinciden", false);

            const snap = await usersRef.child(sessionUser).once("value");
            const data = snap.val();

            if (data.password !== old) return displayStatus("Contrase√±a actual incorrecta", false);

            await usersRef.child(sessionUser).update({ password: n1 });

            currentPasswordInput.value = "";
            newPasswordInput.value = "";
            confirmPasswordInput.value = "";

            displayStatus("Contrase√±a actualizada ‚úî");
        });
    </script>

</body>
</html>
