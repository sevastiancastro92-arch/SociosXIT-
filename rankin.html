<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ranking & Premios - SociosXIT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

  <style>
    /* --- FUENTES Y FONDO --- */
    @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700;800&family=Orbitron:wght@400;700&display=swap');
    
    body {
      font-family: 'Rajdhani', sans-serif;
      background-color: #020205;
      color: #fff; 
      min-height: 100vh;
      overflow-x: hidden;
      /* Fondo Grid Animado */
      background-image: 
        linear-gradient(rgba(0, 255, 255, 0.07) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 0, 255, 0.07) 1px, transparent 1px);
      background-size: 40px 40px;
      animation: bgScroll 20s linear infinite;
    }
    
    @keyframes bgScroll { from { background-position: 0 0; } to { background-position: 40px 40px; } }

    /* Scrollbar Neon */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: #020202; }
    ::-webkit-scrollbar-thumb { background: #00f3ff; border-radius: 4px; box-shadow: 0 0 10px #00f3ff; }

    /* Efectos de Texto Ultra Neon */
    .text-glow-pink { color: #ff00ff; text-shadow: 0 0 5px #ff00ff, 0 0 10px #ff00ff, 0 0 20px #ff00ff; }
    .text-glow-cyan { color: #00ffff; text-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff, 0 0 20px #00ffff; }
    .font-orbitron { font-family: 'Orbitron', sans-serif; }

    /* Contenedores con Borde Brillante */
    .neon-card {
      background: rgba(10, 10, 15, 0.85);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
    }
    
    /* Ranking C√≠rculos */
    .rank-circle {
      width: 24px; height: 24px; border-radius: 50%;
      display: flex; justify-content: center; align-items: center;
      font-weight: 800; font-size: 12px; margin-right: 6px;
      z-index: 10; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.2);
    }
    @media(min-width: 768px){ .rank-circle { width: 38px; height: 38px; font-size: 18px; margin-right: 12px; } }

    /* --- TOP 3 SUPER BRILLANTES --- */
    
    /* TOP 1: ORO RADIACTIVO */
    .row-top-1 {
      background: linear-gradient(90deg, rgba(255, 215, 0, 0.25), transparent);
      border: 1px solid #FFD700;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.4), inset 0 0 20px rgba(255, 215, 0, 0.1);
      animation: pulseGold 2s infinite alternate;
    }
    .circle-top-1 { background: #FFD700; color: black; box-shadow: 0 0 15px #FFD700; border: 2px solid white; }
    @keyframes pulseGold { from { box-shadow: 0 0 10px rgba(255,215,0,0.3); } to { box-shadow: 0 0 25px rgba(255,215,0,0.6); } }

    /* TOP 2: PLATA CROMADA */
    .row-top-2 {
      background: linear-gradient(90deg, rgba(255, 255, 255, 0.15), transparent);
      border: 1px solid #00f3ff;
      box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
    }
    .circle-top-2 { background: #e0e0e0; color: black; box-shadow: 0 0 10px white; }

    /* TOP 3: BRONCE MAGMA */
    .row-top-3 {
      background: linear-gradient(90deg, rgba(255, 80, 0, 0.15), transparent);
      border: 1px solid #ff5500;
      box-shadow: 0 0 15px rgba(255, 80, 0, 0.3);
    }
    .circle-top-3 { background: #ff7b00; color: white; box-shadow: 0 0 10px #ff7b00; }

    /* OTROS PUESTOS */
    .row-other { 
      background: rgba(20, 20, 25, 0.6); 
      border-bottom: 1px solid rgba(255,255,255,0.05); 
    }
    .circle-other { background: #222; color: #777; border: 1px solid #444; }

    /* CONTENEDOR DE LA FILA */
    .rank-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 6px; margin-bottom: 6px; border-radius: 4px;
      font-size: 11px; transition: all 0.2s;
    }
    @media(min-width: 768px){ .rank-row { padding: 12px; font-size: 13px; margin-bottom: 8px; } }
    .rank-row:hover { background: rgba(255,255,255,0.1); transform: translateX(2px); }

    /* SI SOY YO */
    .is-me-row { 
      background: rgba(255, 0, 255, 0.15) !important;
      border: 1px solid #ff00ff !important; 
      box-shadow: 0 0 15px rgba(255, 0, 255, 0.4) !important;
    }

    /* ESTILO BOTON ADMIN */
    .btn-admin-edit {
        background: red; color: white; border: 1px solid white;
        padding: 2px 6px; border-radius: 4px; margin-left: 5px;
        cursor: pointer; font-weight: bold; font-size: 10px;
        box-shadow: 0 0 5px red;
    }
    .btn-admin-edit:hover { background: darkred; }

    /* Animaciones */
    .animate-tilt { animation: tilt 4s infinite linear; }
    @keyframes tilt { 0%, 50%, 100% { transform: rotate(0deg); } 25% { transform: rotate(1deg); } 75% { transform: rotate(-1deg); } }
  </style>
</head>
<body class="p-2 md:p-6">

  <div class="max-w-6xl mx-auto mb-6 flex justify-between items-center px-1 relative z-10">
    <a href="javascript:history.back()" class="flex items-center gap-2 text-cyan-400 hover:text-white transition px-3 py-1 rounded-full border border-cyan-500/50 bg-cyan-900/20 shadow-[0_0_10px_rgba(0,255,255,0.3)]">
      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M19 12H5M12 19l-7-7 7-7"/></svg> 
      <span class="text-xs font-bold tracking-widest uppercase">Volver</span>
    </a>
    <div class="text-right bg-black/80 p-2 rounded border border-pink-500/50 shadow-[0_0_10px_rgba(255,0,255,0.2)]">
      <div id="headerUserName" class="font-bold text-glow-pink text-xs tracking-widest">...</div>
      <div id="headerBalance" class="text-[10px] text-cyan-300 font-mono font-bold">$0.00</div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto relative z-10">
    <div class="text-center mb-6 relative">
      <div class="absolute inset-0 flex justify-center items-center blur-xl opacity-30">
        <h1 class="text-6xl font-black text-purple-600">RANKINGS</h1>
      </div>
      <h1 class="text-4xl md:text-7xl font-black italic tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-white to-pink-500 filter drop-shadow-[0_0_10px_rgba(0,255,255,0.8)] uppercase font-orbitron">
        RANKINGS
      </h1>
      <p class="text-cyan-200 text-[10px] md:text-sm font-bold tracking-[0.3em] mt-2 uppercase text-shadow">üèÜ Gana $5 USD - Top 1 üèÜ</p>
    </div>
    
    <div class="flex justify-center mb-8">
      <div class="text-[9px] text-white font-bold bg-gradient-to-r from-purple-900 to-pink-900 border border-pink-500 px-4 py-1 rounded-full shadow-[0_0_15px_#ff00ff] animate-pulse">
        ‚ö° ACTUALIZACI√ìN EN VIVO: 30s ‚ö°
      </div>
    </div>

    <div class="flex justify-center mb-10">
      <div class="relative group w-64 md:w-96 transition-all duration-500 hover:scale-105">
        <div class="absolute -inset-1 bg-gradient-to-r from-cyan-400 via-purple-500 to-pink-500 rounded-2xl blur opacity-75 group-hover:opacity-100 animate-tilt"></div>
        <div class="relative px-6 py-8 bg-[#050508] rounded-2xl flex flex-col items-center border border-white/20">
          <div class="text-6xl mb-3 filter drop-shadow-[0_0_20px_rgba(255,215,0,0.8)] animate-bounce">üëë</div>
          <div class="text-5xl font-black text-white mb-2 tracking-tighter font-orbitron" style="text-shadow: 0 0 20px #00ffff, 0 0 40px #ff00ff;">$5 USD</div>
          <div class="text-pink-400 text-[10px] font-bold tracking-[0.2em] uppercase text-center border-t border-white/10 pt-3 w-full">
            Premio Top 1 ‚Ä¢ <span class="text-cyan-300">Cierre: D√≠a 11</span>
          </div>
        </div>
      </div>
    </div>

    <div class="max-w-md mx-auto mb-8 neon-card p-4 rounded-xl border-pink-500/50">
      <div class="text-center text-glow-pink text-[10px] md:text-sm font-black mb-3 tracking-[0.2em] uppercase border-b border-pink-500/30 pb-2">‚è∞ TIEMPO RESTANTE</div>
      <div class="grid grid-cols-4 gap-2 text-center divide-x divide-pink-500/30" id="countdownTimer"></div>
    </div>

    <div class="grid grid-cols-2 gap-3 md:gap-10 h-[550px] md:h-[700px]">
      
      <div class="neon-card rounded-xl overflow-hidden flex flex-col h-full border-cyan-500/30 shadow-[0_0_15px_rgba(0,255,255,0.15)]">
        <div class="p-3 md:p-5 border-b border-cyan-500/30 bg-gradient-to-b from-cyan-900/40 to-transparent text-center relative">
            <h2 class="text-xs md:text-2xl font-black text-cyan-100 uppercase tracking-widest font-orbitron drop-shadow-[0_0_5px_cyan]">Top Recargas</h2>
            <div id="myRankRecharge" class="hidden mt-2 py-1 px-3 rounded-full bg-black border border-cyan-400 text-cyan-300 font-bold text-[9px] shadow-[0_0_10px_cyan] inline-block"></div>
        </div>
        <div id="listRecharges" class="flex-1 p-2 md:p-4 overflow-y-auto custom-scroll">
            <p class="text-center text-cyan-500/50 text-[10px] mt-10 animate-pulse font-mono">CARGANDO DATOS...</p>
        </div>
      </div>

      <div class="neon-card rounded-xl overflow-hidden flex flex-col h-full border-pink-500/30 shadow-[0_0_15px_rgba(255,0,255,0.15)]">
        <div class="p-3 md:p-5 border-b border-pink-500/30 bg-gradient-to-b from-pink-900/40 to-transparent text-center relative">
            <h2 class="text-xs md:text-2xl font-black text-pink-100 uppercase tracking-widest font-orbitron drop-shadow-[0_0_5px_magenta]">Top Gastos</h2>
            <div id="myRankSales" class="hidden mt-2 py-1 px-3 rounded-full bg-black border border-pink-400 text-pink-300 font-bold text-[9px] shadow-[0_0_10px_magenta] inline-block"></div>
        </div>
        <div id="listSales" class="flex-1 p-2 md:p-4 overflow-y-auto custom-scroll">
            <p class="text-center text-pink-500/50 text-[10px] mt-10 animate-pulse font-mono">CARGANDO DATOS...</p>
        </div>
      </div>

    </div>
  </div>

  <button id="adminToggleBtn" class="hidden fixed bottom-5 right-5 z-50 bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-full border-2 border-white shadow-[0_0_20px_red] animate-pulse">
    üíÄ ADMIN
  </button>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCr1-2dIqgxoXBTKYgSusnUZorUICX2Too",
      authDomain: "chatglobal-e9370.firebaseapp.com",
      databaseURL: "https://chatglobal-e9370-default-rtdb.firebaseio.com",
      projectId: "chatglobal-e9370",
      storageBucket: "chatglobal-e9370.firebasestorage.app",
      messagingSenderId: "382420208590",
      appId: "1:382420208590:web:9425fa28c8cdf669adb99f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const currentUser = sessionStorage.getItem("sociosxit_user");
    if (!currentUser) window.location.href = "index.html";
    else {
        document.getElementById('headerUserName').textContent = currentUser.split('@')[0].toUpperCase();
        loadUserBalance();
        checkAdmin();
    }

    const listRecharges = document.getElementById("listRecharges");
    const listSales = document.getElementById("listSales");
    const myRankRecharge = document.getElementById("myRankRecharge");
    const myRankSales = document.getElementById("myRankSales");
    const countdownTimer = document.getElementById("countdownTimer");
    const adminToggleBtn = document.getElementById("adminToggleBtn");

    let adminMode = false; // Estado del modo edici√≥n

    function sanitizeEmail(email) { return email.replace(/\./g, "_"); }
    
    function loadUserBalance() {
        const userKey = sanitizeEmail(currentUser);
        db.ref(`users/${userKey}/balance`).on("value", snap => {
            const val = parseFloat(snap.val() || 0);
            document.getElementById('headerBalance').textContent = `$${val.toFixed(2)}`;
        });
    }

    // --- LOGICA ADMIN ---
    function checkAdmin() {
        // Verifica si el usuario actual contiene LK-XT
        if (currentUser.toUpperCase().includes("LK-XT") || currentUser.toUpperCase().includes("LK XT")) {
            adminToggleBtn.classList.remove("hidden");
            adminToggleBtn.addEventListener("click", () => {
                adminMode = !adminMode;
                adminToggleBtn.textContent = adminMode ? "‚ùå SALIR ADMIN" : "üíÄ ADMIN";
                adminToggleBtn.style.background = adminMode ? "#000" : "red";
                // Recargar Rankings para mostrar botones
                loadRankings(); 
            });
        }
    }

    window.editUserBalance = function(userId, currentName) {
        const amountStr = prompt(`ADMIN LK-XT:\nEditar saldo para: ${currentName}\n\nIngresa cantidad a SUMAR o RESTAR (ej: 10 o -50):`);
        if (!amountStr) return;

        const amount = parseFloat(amountStr);
        if (isNaN(amount)) { alert("N√∫mero inv√°lido"); return; }

        db.ref('users/' + userId + '/balance').transaction((currentBalance) => {
            return (currentBalance || 0) + amount;
        }, (error, committed, snapshot) => {
            if (error) {
                alert('Error al actualizar');
            } else if (committed) {
                alert(`‚úÖ Saldo actualizado exitosamente para ${currentName}.`);
            }
        });
    }

    // --- L√ìGICA PRINCIPAL ---
    async function loadRankings() {
      const myEmail = sanitizeEmail(currentUser);
      const now = new Date();
      const currentDay = now.getDate();
      
      let cycleStartDate;
      if (currentDay >= 11) {
          cycleStartDate = new Date(now.getFullYear(), now.getMonth(), 11, 0, 0, 0);
      } else {
          cycleStartDate = new Date(now.getFullYear(), now.getMonth() - 1, 11, 0, 0, 0);
      }

      try {
        const snapshot = await db.ref('users').once('value');
        const usersData = snapshot.val();
        if (!usersData) return;

        const rankingData = [];

        Object.keys(usersData).forEach(key => {
            let displayName = key.replace(/_gmail_com|_hotmail_com|_outlook_com/g, "").replace(/_/g, "");
            
            // Ocultar al admin de la lista
            if (displayName === "LK-XT" || displayName === "LK XT" || key.includes("LK-XT")) return;

            const u = usersData[key];
            
            let cycleSpent = 0; 
            if (u.purchases) {
                Object.values(u.purchases).forEach(p => {
                    const price = parseFloat(p.price || 0);
                    const pDate = new Date(p.date);
                    if (pDate >= cycleStartDate) cycleSpent += price;
                });
            }

            let cycleRecharged = 0;
            if (u.recharge_history) {
                Object.values(u.recharge_history).forEach(r => {
                    const amount = parseFloat(r.amount || 0);
                    const rDate = new Date(r.date);
                    if (rDate >= cycleStartDate) cycleRecharged += amount;
                });
            }

            // Nombre corto
            if(displayName.length > 7) displayName = displayName.substring(0, 7) + "..";

            rankingData.push({
                id: key,
                name: displayName,
                cycleSpent: cycleSpent,
                cycleRecharged: cycleRecharged,
                isMe: key === myEmail
            });
        });

        rankingData.sort((a, b) => b.cycleRecharged - a.cycleRecharged);
        renderList(rankingData, listRecharges, 'cycleRecharged', myRankRecharge, '$');

        rankingData.sort((a, b) => b.cycleSpent - a.cycleSpent);
        renderList(rankingData, listSales, 'cycleSpent', myRankSales, '$');

      } catch (error) {
        console.error("Error ranking:", error);
      }
    }

    // --- RENDERIZADO ---
    function renderList(data, container, valueKey, myAlert, prefix) {
        container.innerHTML = "";
        const topData = data.slice(0, 20); // Top 20
        
        topData.forEach((user, index) => {
            const rank = index + 1;
            
            let rowClass = "row-other";
            let circleClass = "circle-other";
            let textClass = "text-gray-500 font-semibold";
            let icon = "";

            if (rank === 1) {
                rowClass = "row-top-1";
                circleClass = "circle-top-1";
                textClass = "text-yellow-100 font-black drop-shadow-[0_0_5px_gold]";
                icon = "üëë";
            } else if (rank === 2) {
                rowClass = "row-top-2";
                circleClass = "circle-top-2";
                textClass = "text-white font-bold drop-shadow-[0_0_5px_white]";
                icon = "ü•à";
            } else if (rank === 3) {
                rowClass = "row-top-3";
                circleClass = "circle-top-3";
                textClass = "text-orange-200 font-bold drop-shadow-[0_0_5px_orange]";
                icon = "ü•â";
            }

            if (user.isMe) {
                rowClass = "is-me-row";
                textClass = "text-fuchsia-200 font-bold tracking-wider drop-shadow-[0_0_5px_magenta]";
            }

            const finalAmountClass = (valueKey === 'cycleSpent' && user[valueKey] > 0) ? "text-pink-300 drop-shadow-[0_0_3px_magenta]" : (user[valueKey] > 0 ? "text-cyan-300 drop-shadow-[0_0_3px_cyan]" : "text-gray-700");

            // --- L√ìGICA DE BOTON DE EDICI√ìN ADMIN ---
            let adminBtnHtml = "";
            // Solo mostrar bot√≥n editar si AdminMode es true y estamos en la lista de Recargas (como pediste)
            if (adminMode && valueKey === 'cycleRecharged') {
                adminBtnHtml = `<button onclick="editUserBalance('${user.id}', '${user.name}')" class="btn-admin-edit">‚úèÔ∏è</button>`;
            }

            const html = `
                <div class="rank-row ${rowClass}">
                    <div class="flex items-center overflow-hidden w-2/3">
                        <div class="rank-circle ${circleClass}">${rank}</div>
                        <div class="flex flex-col min-w-0">
                            <span class="${textClass} uppercase truncate flex items-center gap-1">
                                ${user.name} <span class="text-[10px]">${icon}</span> ${adminBtnHtml}
                            </span>
                        </div>
                    </div>
                    <div class="font-mono ${finalAmountClass} tracking-tighter text-[10px] md:text-sm ml-1 text-right w-1/3 font-bold">
                        ${prefix}${user[valueKey].toFixed(2)}
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });

        const myIndex = data.findIndex(u => u.isMe);
        if (myIndex !== -1) {
            const val = data[myIndex][valueKey];
            myAlert.innerHTML = `PUESTO #${myIndex + 1} <span class="text-white">($${val.toFixed(2)})</span>`;
            myAlert.classList.remove("hidden");
        } else {
            myAlert.classList.add("hidden");
        }
    }

    // --- TIMER ---
    function startCountdown() {
        const updateTimer = () => {
            const now = new Date();
            let nextReset;
            if (now.getDate() < 11) nextReset = new Date(now.getFullYear(), now.getMonth(), 11, 0, 0, 0);
            else nextReset = new Date(now.getFullYear(), now.getMonth() + 1, 11, 0, 0, 0);

            const diff = nextReset - now;
            if (diff <= 0) { countdownTimer.innerHTML = "<div class='col-span-4 text-glow-pink font-bold animate-pulse'>¬°CIERRE DE CICLO!</div>"; return; }

            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);

            const item = (num, label) => `
                <div>
                    <span class="text-lg md:text-3xl font-black text-white block font-mono" style="text-shadow: 0 0 10px #ff00ff; -webkit-text-stroke: 1px rgba(255,0,255,0.3);">${num<10?'0'+num:num}</span>
                    <span class="text-[8px] text-pink-400 font-bold uppercase tracking-widest">${label}</span>
                </div>`;
            countdownTimer.innerHTML = item(d,"DIAS") + item(h,"HRS") + item(m,"MIN") + item(s,"SEG");
        };
        updateTimer(); setInterval(updateTimer, 1000);
    }

    loadRankings();
    startCountdown();
    setInterval(loadRankings, 30000); 
  </script>
</body>
</html>
