<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - SociosXIT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Eliminadas importaciones V8, usaremos m√≥dulos V9 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    /* Estilos personalizados para el look Neon y el canvas */
    :root {
      --neon-cyan: #00e0ff;
      --neon-green: #39ff14;
      --neon-pink: #ff073a;
      --neon-yellow: #fefe33;
    }
    body {
        font-family: 'Inter', sans-serif;
        background-color: #1a1a2e; /* Dark theme background */
        min-height: 100vh;
        color: white;
        padding-top: 50px; /* Space for the floating menu */
    }
    .app-root {
        position: relative;
        z-index: 10;
        max-width: 1200px;
        margin: 0 auto;
    }
    .card {
        background-color: rgba(30, 30, 50, 0.7);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 12px;
    }
    .neon-btn {
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        background-color: #2c2c4c;
    }
    .neon-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 5px var(--neon-cyan), 0 0 10px var(--neon-cyan);
    }
    .menu-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border-radius: 8px;
        cursor: pointer;
        margin-bottom: 8px;
    }
    .text-neon-cyan { color: var(--neon-cyan); }
    .text-neon-green { color: var(--neon-green); }
    .text-neon-pink { color: var(--neon-pink); }
    .text-neon-yellow { color: var(--neon-yellow); }

    .small-muted {
        color: #9ca3af;
        font-size: 0.875rem;
    }

    /* Tabs */
    .tabs {
        display: flex;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #374151;
        gap: 0.5rem;
    }
    .tab-btn {
        padding: 0.75rem 1.25rem;
        border-radius: 8px 8px 0 0;
        border: none;
        background-color: transparent;
        color: #9ca3af;
        font-weight: 600;
        transition: color 0.2s, background-color 0.2s;
    }
    .tab-btn.active {
        background-color: #374151;
        color: white;
        border-bottom: 2px solid var(--neon-cyan);
    }

    /* Progress Bar */
    .progress-bar {
        height: 8px;
        background-color: #374151;
        border-radius: 9999px;
        overflow: hidden;
    }
    .progress-fill {
        height: 100%;
        background-image: linear-gradient(to right, var(--neon-cyan), var(--neon-green));
        transition: width 0.5s ease-out;
    }
    .level-label {
        font-weight: bold;
        color: var(--neon-green);
        text-shadow: 0 0 5px rgba(57, 255, 20, 0.5);
    }

    /* Modal Styles */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 50;
    }

    .modal {
      background-color: #1a1a2e;
      padding: 24px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      border: 1px solid var(--neon-cyan);
      box-shadow: 0 0 15px rgba(0, 224, 255, 0.3);
      position: relative;
    }

    .modal .actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 20px;
    }

    /* Side Menu/Hamburger */
    .hamburger {
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 100;
      cursor: pointer;
      padding: 10px;
      background-color: #2c2c4c;
      border-radius: 8px;
      border: 1px solid var(--neon-cyan);
      box-shadow: 0 0 5px rgba(0, 224, 255, 0.5);
      transition: all 0.3s;
    }
    .hamburger:hover {
      background-color: #374151;
    }
    .burger span {
      display: block;
      width: 25px;
      height: 3px;
      margin: 5px 0;
      background-color: var(--neon-cyan);
      transition: all 0.3s ease-in-out;
    }
    .side-menu {
      position: fixed;
      top: 0;
      left: 0;
      width: 280px;
      height: 100%;
      background-color: #1a1a2e;
      z-index: 90;
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
      padding: 20px;
      display: flex;
      flex-direction: column;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
      overflow-y: auto;
      border-right: 2px solid var(--neon-cyan);
    }
    .side-menu.open {
      transform: translateX(0);
    }
    .menu-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 80;
      display: none;
    }
    .menu-backdrop.open {
      display: block;
    }
    .menu-user {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 0;
      margin-bottom: 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-color: var(--neon-pink);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #1a1a2e;
      border: 2px solid var(--neon-pink);
    }

    /* Key Card Custom Styling */
    .key-card {
        transition: border 0.3s ease;
    }

    #particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }
  </style>
</head>
<body class="text-white p-4 md:p-8">
  <!-- Part√≠culas Canvas (Efecto Visual) -->
  <canvas id="particles"></canvas>
  
  <!-- Contenido Principal -->
  <div class="app-root">
    
    <!-- Hamburguer Menu -->
    <div id="hamburgerBtn" class="hamburger" aria-label="Men√∫">
      <div class="burger">
        <span></span><span></span><span></span>
      </div>
    </div>
    
    <div id="menuBackdrop" class="menu-backdrop"></div>
    <aside id="sideMenu" class="side-menu" aria-hidden="true">
      <div class="menu-user">
        <div class="avatar" id="menuAvatar">UX</div>
        <div>
          <div id="menuUserName" class="font-semibold text-lg text-neon-cyan">Usuario</div>
          <div id="menuUserBalance" class="small-muted mt-1">Saldo: $0.00</div>
        </div>
      </div>
      <div style="height:8px;"></div>
      
      <div class="card p-3 rounded-lg border-white/5">
          <div class="flex justify-between items-center mb-1">
              <div id="userLevelTextMenu" class="level-label">Nivel: Base</div>
              <div id="levelProgressTextMenu" class="small-muted text-xs">$0.00 / $50.00</div>
          </div>
          <div class="progress-bar">
              <div id="levelProgressBarMenu" class="progress-fill" style="width: 0%;"></div>
          </div>
          <div id="levelNextGoalMenu" class="small-muted text-xs mt-1">
              Pr√≥x. nivel (VIP): $50.00 (10% Desc.)
          </div>
      </div>
      <div style="height:8px;"></div>
      
      <div id="menuRecharge" class="menu-item neon-btn">
        <div class="text-neon-green">üí≥ Recargar Saldo</div>
        <div class="small-muted">Abrir</div>
      </div>

      <a href="https://docs.google.com/document/d/1eeOCnYJDjFJIGpY8sfuoFdVve1d_jSrnkxSHqqqKieg/edit?usp=drivesdk" 
         target="_blank" 
         class="menu-item neon-btn">
        <div class="text-neon-cyan">üìö Tutoriales</div>
        <div class="small-muted">Ver gu√≠a</div>
      </a>

      <div id="menuPublicaciones" class="menu-item neon-btn">
        <div class="text-neon-pink">üì¶ Publicaciones</div>
        <div class="small-muted">Ir</div>
      </div>

      <div id="menuKeys" class="menu-item neon-btn">
        <div class="text-neon-green">üîë Mis Keys</div>
        <div class="small-muted">Historial</div>
      </div>

      <a href="resets.html" class="menu-item neon-btn">
        <div class="text-neon-yellow">‚ôªÔ∏è Sistemas de Resets</div>
        <div class="small-muted">Abrir</div>
      </a>

      <div id="menuLogout" class="menu-item neon-btn">
        <div class="text-neon-pink">üö™ Cerrar sesi√≥n</div>
        <div class="small-muted">Salir</div>
      </div>

      <div style="flex:1"></div>
      <div class="small-muted text-xs">SociosXIT ‚Ä¢ Men√∫</div>
    </aside>

    <!-- Header / Bloque de Usuario -->
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 p-4 rounded-lg card">
      <div class="user-block">
        <h1 class="text-2xl font-bold">Bienvenido, <span id="userName" class="text-blue-300">Cargando...</span></h1>
        <p class="text-sm text-gray-300">Publicaciones disponibles para ti</p>
        <p class="text-lg mt-2">üí∞ Saldo: <span id="userBalance" class="font-bold text-green-400">$0.00</span> USD</p>
      </div>
      <div class="header-right">
        <button id="logoutBtn" class="btn-logout neon-btn font-semibold py-2 px-4 rounded-lg transition-transform hover:scale-105">
          Cerrar Sesi√≥n
        </button>
      </div>
    </header>
    
    <!-- Pesta√±as de Navegaci√≥n -->
    <div class="tabs">
      <button id="tabPublicaciones" class="tab-btn active neon-btn">üì¶ Publicaciones</button>
      <button id="tabKeys" class="tab-btn neon-btn">üîë Mis Keys</button>
    </div>

    <!-- Barra de Nivel Principal -->
    <div id="mainLevelBar" class="card p-4 rounded-xl border-white/5 mb-6">
        <div class="flex justify-between items-center mb-1">
            <div id="userLevelTextMain" class="level-label">Nivel: Base</div>
            <div id="levelProgressTextMain" class="small-muted text-xs">$0.00 / $50.00</div>
        </div>
        <div class="progress-bar">
            <div id="levelProgressBarMain" class="progress-fill" style="width: 0%;"></div>
        </div>
        <div id="levelNextGoalMain" class="small-muted text-xs mt-1">
            Pr√≥x. nivel (VIP): $50.00 (10% Desc.)
        </div>
    </div>
    
    <!-- Contenedor de Publicaciones (Visible por defecto) -->
    <main id="publicationsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="card p-4 rounded-xl text-center text-gray-400">Cargando publicaciones... (Solo es un placeholder)</div>
    </main>

    <!-- Contenedor de Keys (Hidden por defecto) -->
    <section id="myKeysContainer" class="hidden">
      <h2 class="text-xl font-semibold mb-4">üîí Historial de Keys compradas</h2>
      <div class="flex flex-col md:flex-row gap-3 mb-4">
        <input id="searchKeyInput" type="text" placeholder="üîç Buscar por nombre o clave..."
        class="w-full md:w-1/2 px-3 py-2 rounded-lg bg-gray-800 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-400 placeholder-gray-400">
        <select id="filterDateSelect" class="px-3 py-2 rounded-lg bg-gray-800 text-white border border-gray-600 focus:ring-2 focus:ring-blue-400">
          <option value="all">üìÖ Todos</option>
          <option value="today">Hoy</option>
          <option value="7days">√öltimos 7 d√≠as</option>
          <option value="month">Este mes</option>
        </select>
      </div>
      
      <!-- ‚úîÔ∏è NUEVO BOT√ìN PARA ELIMINAR EXPIRADAS -->
      <button id="deleteExpiredBtn" 
              class="w-full mb-6 py-3 px-4 rounded-lg bg-red-600 text-white font-bold transition-colors hover:bg-red-700 disabled:bg-red-900/50 disabled:cursor-not-allowed">
        ‚ùå Eliminar Todas las Keys Expiradas
      </button>

      <div id="myKeysList" class="grid grid-cols-1 gap-4">
        <p class="text-center text-gray-400 mt-8">Cargando keys...</p>
      </div>
    </section>

    <!-- Modal de Confirmaci√≥n (Usado para Compras y Eliminaciones) -->
    <div id="confirmModal" class="modal-backdrop hidden">
      <div class="modal">
        <div id="confirmHeader" class="text-lg font-semibold mb-2 text-neon-yellow">Confirmar Acci√≥n</div>
        <div id="confirmText" class="small-muted">¬øDeseas confirmar esta acci√≥n?</div>
        <div id="finalPriceDisplay" class="text-xl font-bold mt-2 hidden"></div>
        <div class="actions">
          <button id="confirmCancel" class="py-2 px-4 rounded-lg border border-white/10">Cancelar</button>
          <button id="confirmOk" class="py-2 px-4 rounded-lg bg-green-500 font-semibold neon-btn">Aceptar</button>
        </div>
      </div>
    </div>

    <!-- Modal de Mensaje/Key Entregada -->
    <div id="keyModal" class="modal-backdrop hidden">
      <div class="modal">
        <div id="modalTitle" class="text-lg font-semibold mb-2 text-neon-cyan">Mensaje</div>
        <div id="keyModalContent" class="small-muted">Aqu√≠ va el contenido del mensaje o la clave.</div>
        <div class="actions">
          <button id="keyCopyBtn" class="py-2 px-4 rounded-lg bg-white text-blue-900 font-semibold hidden">Copiar</button>
          <button id="keyCloseBtn" class="py-2 px-4 rounded-lg border border-white/10">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Modal de Recarga -->
    <div id="rechargeModal" class="modal-backdrop hidden">
      <div class="modal">
        <div class="text-lg font-semibold mb-4 text-neon-green">Recargar Saldo üí≥</div>
        <div class="small-muted mb-2">M√≠nimo de recarga: $4.00 USD</div>
        
        <input id="rechargeAmountInput" type="number" min="4" step="0.01" placeholder="Monto a recargar (USD)"
               class="w-full px-4 py-3 rounded-lg bg-gray-800 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-400 placeholder-gray-400 text-2xl font-bold">
        
        <p id="rechargeError" class="text-sm text-red-400 mt-2 hidden">El monto m√≠nimo de recarga es $4.00 USD.</p>

        <div class="actions mt-5">
          <button id="rechargeCancelBtn" class="py-2 px-4 rounded-lg border border-white/10">Cancelar</button>
          <button id="rechargeConfirmBtn" class="py-2 px-4 rounded-lg bg-green-500 font-semibold neon-btn">Recargar</button>
        </div>
      </div>
    </div>

  </div>
  
  <script type="module">
    // --- FIREBASE V9 IMPORTS (MANDATORY) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        deleteDoc, 
        onSnapshot, 
        collection, 
        query, 
        where, 
        getDocs, 
        setDoc,
        serverTimestamp,
        // Agrega setLogLevel para debuguear en consola
        setLogLevel
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Configuraciones de variables globales
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Inicializaci√≥n de Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    setLogLevel('Debug'); // Para ver logs en consola

    let userId = null;
    let keysData = []; // Almacena los datos de las keys para su uso global

    // --- UTILITIES & MODALS ---

    function showKeyModal(title, content, showCopy = false, copyText = '') {
      const modal = document.getElementById('keyModal');
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('keyModalContent').textContent = content;
      const copyBtn = document.getElementById('keyCopyBtn');
      
      if (showCopy) {
        copyBtn.classList.remove('hidden');
        copyBtn.onclick = () => {
          // Usamos document.execCommand('copy') por restricciones del iframe
          const tempInput = document.createElement('textarea');
          tempInput.value = copyText;
          document.body.appendChild(tempInput);
          tempInput.select();
          document.execCommand('copy');
          document.body.removeChild(tempInput);
          copyBtn.textContent = '¬°Copiado!';
          setTimeout(() => copyBtn.textContent = 'Copiar', 2000);
        };
      } else {
        copyBtn.classList.add('hidden');
      }

      modal.classList.remove('hidden');
    }

    function showConfirmModal(text, onConfirm, isPurchase = false, price = null) {
      const modal = document.getElementById('confirmModal');
      document.getElementById('confirmText').textContent = text;
      
      const priceDisplay = document.getElementById('finalPriceDisplay');
      if (isPurchase && price !== null) {
          document.getElementById('confirmHeader').textContent = 'Confirmar compra';
          priceDisplay.textContent = `Precio: $${price.toFixed(2)} USD`;
          priceDisplay.classList.remove('hidden');
      } else {
          document.getElementById('confirmHeader').textContent = 'Confirmar acci√≥n';
          priceDisplay.classList.add('hidden');
      }

      const confirmOk = document.getElementById('confirmOk');
      confirmOk.textContent = isPurchase ? 'Comprar' : 'Aceptar';

      modal.classList.remove('hidden');

      const handleOk = () => {
        onConfirm();
        modal.classList.add('hidden');
        confirmOk.removeEventListener('click', handleOk);
      };

      const handleCancel = () => {
        modal.classList.add('hidden');
        confirmOk.removeEventListener('click', handleOk);
      };

      confirmOk.addEventListener('click', handleOk, { once: true });
      document.getElementById('confirmCancel').addEventListener('click', handleCancel, { once: true });
    }

    document.getElementById('keyCloseBtn').addEventListener('click', () => {
      document.getElementById('keyModal').classList.add('hidden');
    });

    // --- KEY EXPIRATION LOGIC ---
    
    // Funci√≥n para formatear el tiempo restante de la key
    function formatRemainingTime(milliseconds) {
        if (milliseconds <= 0) {
            return { status: 'EXPIRADA', color: 'bg-red-600' };
        }

        const seconds = Math.floor(milliseconds / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (days > 0) return { status: `Restan ${days}d ${hours % 24}h`, color: 'bg-yellow-500' };
        if (hours > 0) return { status: `Restan ${hours}h ${minutes % 60}m`, color: 'bg-yellow-500' };
        if (minutes > 0) return { status: `Restan ${minutes}m ${seconds % 60}s`, color: 'bg-orange-500' };
        return { status: `Restan ${seconds}s`, color: 'bg-orange-500' };
    }

    // Funci√≥n para renderizar el listado de keys
    function renderKeysList(keys) {
        const listContainer = document.getElementById('myKeysList');
        const deleteExpiredBtn = document.getElementById('deleteExpiredBtn');
        listContainer.innerHTML = '';
        let hasExpiredKeys = false;
        keysData = keys; // Almacenamos para uso global (como en deleteExpiredKeys)

        if (keys.length === 0) {
            listContainer.innerHTML = '<p class="text-center text-gray-400 mt-8">A√∫n no tienes keys compradas.</p>';
            deleteExpiredBtn.disabled = true;
            return;
        }

        keys.forEach(key => {
            // C√°lculo de expiraci√≥n (DurationDays en d√≠as)
            const durationMs = key.durationDays * 24 * 60 * 60 * 1000;
            const purchaseDate = key.purchaseTimestamp instanceof Object ? key.purchaseTimestamp.toDate().getTime() : key.purchaseTimestamp;
            const expirationTime = purchaseDate + durationMs;
            const now = Date.now();
            const remainingTimeMs = expirationTime - now;
            const isExpired = remainingTimeMs <= 0;

            if (isExpired) {
                hasExpiredKeys = true;
            }

            const { status, color } = formatRemainingTime(remainingTimeMs);

            const keyItem = `
                <div class="key-card card p-4 rounded-xl flex flex-col md:flex-row justify-between items-start md:items-center ${isExpired ? 'border-red-500/50' : 'border-green-500/50'}">
                    <div class="flex-1 min-w-0 mb-3 md:mb-0">
                        <div class="text-lg font-bold truncate">${key.name}</div>
                        <div class="small-muted text-sm mt-1 mb-2 md:mb-0 text-white/70 truncate">${key.key}</div>
                    </div>

                    <div class="flex items-center gap-4">
                        <!-- EXPIRATION STATUS Y TIEMPO RESTANTE -->
                        <div class="text-right">
                            <span class="text-xs font-semibold px-2 py-1 rounded-full text-white ${color} whitespace-nowrap">
                                ${status}
                            </span>
                            <div class="text-xs text-gray-400 mt-1">
                                Duraci√≥n: ${key.durationDays} d√≠a(s)
                            </div>
                        </div>
                        
                        <!-- ‚úîÔ∏è BOT√ìN DE ELIMINAR KEY INDIVIDUAL -->
                        <button data-key-id="${key.id}" class="delete-key-btn py-2 px-3 rounded-lg bg-red-500 font-semibold text-sm neon-btn transition-colors hover:bg-red-600" title="Eliminar Key Permanentemente">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `;
            listContainer.insertAdjacentHTML('beforeend', keyItem);
        });

        // Habilitar/Deshabilitar el bot√≥n de eliminar expiradas
        deleteExpiredBtn.disabled = !hasExpiredKeys;

        // Adjuntar event listeners para botones de eliminaci√≥n individual
        document.querySelectorAll('.delete-key-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const keyId = e.currentTarget.dataset.keyId;
                const keyName = keys.find(k => k.id === keyId)?.name || 'esta key';
                showConfirmModal(`¬øEst√°s seguro de que quieres eliminar permanentemente la key "${keyName}"? Esta acci√≥n no se puede deshacer.`, 
                    () => deleteKey(keyId), 
                    false // No es una compra
                );
            });
        });
    }

    // Funci√≥n para eliminar una sola key de Firestore
    async function deleteKey(keyId) {
        if (!userId || !db) return console.error('Firebase no inicializado o usuario no autenticado.');

        try {
            const keyRef = doc(db, `artifacts/${appId}/users/${userId}/keys`, keyId);
            await deleteDoc(keyRef);
            console.log(`Key ${keyId} eliminada correctamente.`);
            showKeyModal('√âxito', 'La key ha sido eliminada permanentemente.');
        } catch (error) {
            console.error('Error al eliminar la key:', error);
            showKeyModal('Error', 'Hubo un error al intentar eliminar la key. Revisa la consola para m√°s detalles.');
        }
    }

    // Funci√≥n para eliminar todas las keys expiradas de Firestore
    async function deleteExpiredKeys() {
        if (!userId || !db) return console.error('Firebase no inicializado o usuario no autenticado.');
        
        // Confirmaci√≥n antes de la eliminaci√≥n masiva
        showConfirmModal('¬øEst√°s seguro de que quieres eliminar TODAS las keys expiradas? Esta acci√≥n es permanente.', async () => {
            try {
                const expiredKeys = keysData.filter(key => {
                    const durationMs = key.durationDays * 24 * 60 * 60 * 1000;
                    const purchaseDate = key.purchaseTimestamp instanceof Object ? key.purchaseTimestamp.toDate().getTime() : key.purchaseTimestamp;
                    const expirationTime = purchaseDate + durationMs;
                    return expirationTime <= Date.now();
                });

                if (expiredKeys.length === 0) {
                    showKeyModal('Informaci√≥n', 'No se encontraron keys expiradas para eliminar.');
                    return;
                }

                // Eliminaci√≥n en batch (o en paralelo con Promise.all)
                const keysCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/keys`);
                const deletePromises = expiredKeys.map(key => {
                    return deleteDoc(doc(keysCollectionRef, key.id));
                });

                await Promise.all(deletePromises);
                console.log(`${expiredKeys.length} keys expiradas eliminadas correctamente.`);
                showKeyModal('√âxito', `Se eliminaron ${expiredKeys.length} keys expiradas permanentemente.`);

            } catch (error) {
                console.error('Error al eliminar keys expiradas:', error);
                showKeyModal('Error', 'Hubo un error al intentar eliminar las keys expiradas. Revisa la consola.');
            }
        });
    }
    
    // Timer para refrescar el estado de expiraci√≥n cada 10 segundos
    let expirationTimer = null;
    function startExpirationTimer() {
        if (expirationTimer) clearInterval(expirationTimer);
        // Refresca la lista y el estado de expiraci√≥n cada 10 segundos
        expirationTimer = setInterval(() => {
            if (document.getElementById('myKeysContainer').classList.contains('hidden')) return;
            renderKeysList(keysData);
        }, 10000); 
    }

    // Event listener para el bot√≥n de eliminar todas las expiradas
    document.getElementById('deleteExpiredBtn').addEventListener('click', deleteExpiredKeys);

    // --- FIREBASE LISTENERS & AUTHENTICATION ---

    function setupKeysListener() {
        if (!userId) return;
        
        const keysCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/keys`);
        const q = query(keysCollectionRef); // Podr√≠as agregar where/orderBy aqu√≠

        // onSnapshot escucha los cambios en tiempo real (Realtime)
        onSnapshot(q, (snapshot) => {
            const keys = [];
            snapshot.forEach((doc) => {
                // Asumimos que los datos de la key incluyen: key, name, durationDays (int), purchaseTimestamp (Firestore Timestamp or MS)
                keys.push({ id: doc.id, ...doc.data() });
            });
            renderKeysList(keys);
            startExpirationTimer(); // Reinicia el timer para asegurar que est√© activo y renderizando
        }, (error) => {
            console.error("Error al escuchar las keys:", error);
            document.getElementById('myKeysList').innerHTML = '<p class="text-center text-red-400 mt-8">Error al cargar las keys. Revisa tu conexi√≥n.</p>';
        });
    }


    onAuthStateChanged(auth, async (user) => {
        if (user) {
            userId = user.uid;
            console.log("Usuario autenticado. UID:", userId);
            
            // --- C√ìDIGO DE SETUP DEL DASHBOARD ORIGINAL VA AQU√ç ---
            // Simular carga de datos de usuario/saldo
            document.getElementById('userName').textContent = userId.substring(0, 8) + '...';
            document.getElementById('menuUserName').textContent = userId.substring(0, 8) + '...';
            
            // Iniciar el listener de las keys solo despu√©s de obtener el userId
            setupKeysListener(); 

        } else {
            // Si no hay usuario, intenta iniciar sesi√≥n an√≥nimamente o con token
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error en la autenticaci√≥n:", error);
            }
        }
    });

    // --- DASHBOARD UI LOGIC (Mantenido) ---
    
    // Toggle Menu
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const sideMenu = document.getElementById('sideMenu');
    const menuBackdrop = document.getElementById('menuBackdrop');

    const toggleMenu = () => {
        sideMenu.classList.toggle('open');
        menuBackdrop.classList.toggle('open');
        hamburgerBtn.classList.toggle('is-active'); // Si tienes un estilo para "is-active"
    };

    hamburgerBtn.addEventListener('click', toggleMenu);
    menuBackdrop.addEventListener('click', toggleMenu);

    // Tab Switching
    const tabs = {
        'tabPublicaciones': 'publicationsContainer',
        'tabKeys': 'myKeysContainer'
    };
    
    Object.keys(tabs).forEach(tabId => {
        document.getElementById(tabId).addEventListener('click', (e) => {
            // Desactivar todos
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('main, section').forEach(container => container.classList.add('hidden'));

            // Activar el seleccionado
            e.target.classList.add('active');
            document.getElementById(tabs[tabId]).classList.remove('hidden');

            // Controlar el timer de expiraci√≥n
            if (tabId === 'tabKeys') {
                startExpirationTimer();
            } else {
                if (expirationTimer) clearInterval(expirationTimer);
            }
        });
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', () => {
        // En una aplicaci√≥n real, aqu√≠ har√≠as signOut(auth);
        console.log("Cerrar Sesi√≥n simulado.");
        location.reload(); 
    });
    document.getElementById('menuLogout').addEventListener('click', () => {
        console.log("Cerrar Sesi√≥n simulado.");
        location.reload(); 
    });

    // Simulaci√≥n de Recarga (Deber√≠a usar Firebase para manejar transacciones)
    document.getElementById('menuRecharge').addEventListener('click', () => {
        document.getElementById('rechargeModal').classList.remove('hidden');
    });

    document.getElementById('rechargeCancelBtn').addEventListener('click', () => {
        document.getElementById('rechargeModal').classList.add('hidden');
    });

    document.getElementById('rechargeConfirmBtn').addEventListener('click', () => {
        const amount = parseFloat(document.getElementById('rechargeAmountInput').value);
        if (isNaN(amount) || amount < 4) {
            document.getElementById('rechargeError').classList.remove('hidden');
            return;
        }
        document.getElementById('rechargeError').classList.add('hidden');
        document.getElementById('rechargeModal').classList.add('hidden');
        showKeyModal('Recarga Simulada', `Has simulado una recarga de $${amount.toFixed(2)} USD. En una app real, esto iniciar√≠a un proceso de pago.`);
    });
    
    // --- PARTICLE EFFECT (Visual) ---
    const canvas = document.getElementById('particles');
    const ctx = canvas.getContext('2d');
    let particlesArray;

    class Particle {
        constructor(x, y, directionX, directionY, size, color) {
            this.x = x;
            this.y = y;
            this.directionX = directionX;
            this.directionY = directionY;
            this.size = size;
            this.color = color;
        }
        draw() {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
            ctx.fillStyle = this.color;
            ctx.fill();
        }
        update() {
            if (this.x + this.size > canvas.width || this.x - this.size < 0) {
                this.directionX = -this.directionX;
            }
            if (this.y + this.size > canvas.height || this.y - this.size < 0) {
                this.directionY = -this.directionY;
            }
            this.x += this.directionX;
            this.y += this.directionY;
            this.draw();
        }
    }

    function initParticles() {
        particlesArray = [];
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const numberOfParticles = (canvas.height * canvas.width) / 15000;
        const colors = [var(--neon-cyan), var(--neon-green), var(--neon-pink)];
        for (let i = 0; i < numberOfParticles; i++) {
            let size = (Math.random() * 2) + 1;
            let x = (Math.random() * ((canvas.width - size * 2) - (size * 2)) + size * 2);
            let y = (Math.random() * ((canvas.height - size * 2) - (size * 2)) + size * 2);
            let directionX = (Math.random() * 0.4) - 0.2;
            let directionY = (Math.random() * 0.4) - 0.2;
            let color = colors[Math.floor(Math.random() * colors.length)];
            particlesArray.push(new Particle(x, y, directionX, directionY, size, color));
        }
    }

    function animateParticles() {
        requestAnimationFrame(animateParticles);
        ctx.clearRect(0, 0, innerWidth, innerHeight);

        for (let i = 0; i < particlesArray.length; i++) {
            particlesArray[i].update();
        }
    }

    window.onload = function() {
        initParticles();
        animateParticles();
    };

    window.addEventListener('resize', initParticles);
    
  </script>
</body>
</html>

