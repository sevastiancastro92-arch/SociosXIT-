<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Global - SociosXIT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
  
  <style>
    /* === ESTILOS NEON === */
    :root {
      --neon-cyan: #00f3ff;
      --neon-pink: #ff00ff;
      --bg-dark: #050505;
      --glass: rgba(20, 20, 35, 0.9);
    }
    body {
      background-color: var(--bg-dark);
      background-image: radial-gradient(circle at 50% 0%, #221c35 0%, #000 80%);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    /* Header */
    .chat-header {
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--neon-cyan);
      box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
      z-index: 10;
    }

    /* Area de Mensajes */
    #messagesContainer {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      scroll-behavior: smooth;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    /* Scrollbar */
    #messagesContainer::-webkit-scrollbar { width: 6px; }
    #messagesContainer::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

    /* Burbujas de Mensaje */
    .message {
      max-width: 85%;
      padding: 10px 15px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.4;
      position: relative;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Mensaje MIO */
    .self {
      align-self: flex-end;
      background: linear-gradient(135deg, rgba(0, 243, 255, 0.2), rgba(0, 100, 255, 0.2));
      border: 1px solid var(--neon-cyan);
      border-bottom-right-radius: 2px;
      box-shadow: 0 0 10px rgba(0, 243, 255, 0.1);
    }
    .self .username { color: var(--neon-cyan); text-align: right; display: block; font-size: 0.75rem; font-weight: bold; margin-bottom: 4px; }

    /* Mensaje OTROS */
    .other {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-bottom-left-radius: 2px;
    }
    .other .username { color: var(--neon-pink); display: block; font-size: 0.75rem; font-weight: bold; margin-bottom: 4px; }

    /* Imagenes */
    .msg-img {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 5px;
      border: 1px solid rgba(255,255,255,0.3);
      max-height: 300px;
      object-fit: cover;
    }

    /* Input Area */
    .input-area {
      background: rgba(10, 10, 15, 0.95);
      border-top: 1px solid #333;
      padding: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .chat-input {
      flex: 1;
      background: rgba(255,255,255,0.05);
      border: 1px solid #444;
      border-radius: 20px;
      padding: 12px 15px;
      color: white;
      outline: none;
      transition: border 0.3s;
    }
    .chat-input:focus { border-color: var(--neon-cyan); }

    .btn-icon {
      background: none; border: 1px solid var(--neon-cyan);
      color: var(--neon-cyan);
      padding: 10px; border-radius: 50%;
      cursor: pointer;
      transition: all 0.2s;
      display: flex; align-items: center; justify-content: center;
    }
    .btn-icon:hover { background: var(--neon-cyan); color: black; box-shadow: 0 0 15px var(--neon-cyan); }
    
    .btn-back {
      font-size: 14px; font-weight: bold; color: #ddd; text-decoration: none;
      display: flex; align-items: center; gap: 5px;
    }
    .btn-back:hover { color: white; }
  </style>
</head>
<body>

  <header class="chat-header p-4 flex justify-between items-center">
    <a href="index.html" class="btn-back">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
      Volver al Dashboard
    </a>
    <h1 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500">
      CHAT GLOBAL
    </h1>
    <div class="w-8"></div> </header>

  <div id="messagesContainer">
    <div class="text-center text-gray-500 text-sm mt-4">Bienvenido al chat. Sé respetuoso.</div>
  </div>

  <div class="input-area">
    <input type="file" id="imgInput" accept="image/*" style="display: none;">
    
    <button class="btn-icon" id="btnUpload" title="Subir Foto">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
    </button>
    
    <input type="text" id="txtMsg" class="chat-input" placeholder="Escribe un mensaje..." autocomplete="off">
    
    <button class="btn-icon" id="btnSend" title="Enviar">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
    </button>
  </div>

  <script>
    // 1. CONFIGURACIÓN FIREBASE (Tu código exacto)
    const firebaseConfig = {
        apiKey: "AIzaSyCr1-2dIqgxoXBTKYgSusnUZorUICX2Too",
        authDomain: "chatglobal-e9370.firebaseapp.com",
        databaseURL: "https://chatglobal-e9370-default-rtdb.firebaseio.com",
        projectId: "chatglobal-e9370",
        storageBucket: "chatglobal-e9370.firebasestorage.app",
        messagingSenderId: "382420208590",
        appId: "1:382420208590:web:9425fa28c8cdf669adb99f"
    };
    // Inicializar Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    const chatRef = db.ref("globalChat");

    // 2. CONFIGURACIÓN IMGBB
    const IMGBB_API_KEY = "f4a63b9f9af2fd112ded296694732a20";

    // 3. OBTENER USUARIO ACTUAL (Del Dashboard)
    const currentUser = sessionStorage.getItem("sociosxit_user");

    // Si no hay usuario logueado, mandar al login
    if (!currentUser) {
        alert("Debes iniciar sesión primero.");
        window.location.href = "index.html";
    }

    // Elementos DOM
    const messagesContainer = document.getElementById("messagesContainer");
    const txtMsg = document.getElementById("txtMsg");
    const btnSend = document.getElementById("btnSend");
    const btnUpload = document.getElementById("btnUpload");
    const imgInput = document.getElementById("imgInput");

    // --- ENVIAR MENSAJE ---
    function sendMessage(content, type = "text") {
        if (!content.trim()) return;

        chatRef.push({
            user: currentUser,
            content: content,
            type: type,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
        txtMsg.value = "";
        txtMsg.focus();
    }

    // Evento Click Enviar
    btnSend.addEventListener("click", () => sendMessage(txtMsg.value));
    
    // Evento Enter
    txtMsg.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage(txtMsg.value);
    });

    // --- SUBIR IMAGEN (ImgBB) ---
    btnUpload.addEventListener("click", () => imgInput.click());

    imgInput.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Mostrar carga
        const oldIcon = btnUpload.innerHTML;
        btnUpload.innerHTML = `<div class="animate-spin h-5 w-5 border-2 border-cyan-500 rounded-full border-t-transparent"></div>`;

        const formData = new FormData();
        formData.append("image", file);

        try {
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: "POST",
                body: formData
            });
            const data = await response.json();

            if (data.success) {
                // Enviamos la URL de la imagen al chat
                sendMessage(data.data.url, "image");
            } else {
                alert("Error al subir imagen a ImgBB");
            }
        } catch (error) {
            console.error(error);
            alert("Error de conexión");
        } finally {
            btnUpload.innerHTML = oldIcon;
            imgInput.value = "";
        }
    });

    // --- RECIBIR MENSAJES (Realtime) ---
    chatRef.limitToLast(50).on("child_added", (snapshot) => {
        const data = snapshot.val();
        const isMe = data.user === currentUser;

        const msgDiv = document.createElement("div");
        msgDiv.className = `message ${isMe ? "self" : "other"}`;

        let contentHTML = "";
        
        // Determinar si es imagen o texto
        if (data.type === "image") {
            contentHTML = `
                <span class="username">${data.user}</span>
                <a href="${data.content}" target="_blank">
                    <img src="${data.content}" class="msg-img" alt="Imagen enviada">
                </a>
            `;
        } else {
            // Protección básica contra inyección HTML en texto
            const safeText = data.content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            contentHTML = `
                <span class="username">${data.user}</span>
                <div>${safeText}</div>
            `;
        }

        msgDiv.innerHTML = contentHTML;
        messagesContainer.appendChild(msgDiv);
        
        // Auto scroll abajo
        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 100);
    });

  </script>
</body>
</html>
