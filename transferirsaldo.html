<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transferir Saldo - SociosXIT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap');

    :root {
      --neon-cyan: #00f3ff;
      --neon-pink: #ff00ff;
      --neon-green: #00ff9d;
      --bg-dark: #0f0812;
      --glass: rgba(20, 18, 37, 0.7);
    }

    body {
      background-color: var(--bg-dark);
      font-family: 'Rajdhani', sans-serif;
      overflow-x: hidden;
      color: white;
    }

    /* Partículas de fondo (igual que tu dashboard) */
    #particles {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      z-index: -1; pointer-events: none;
    }

    /* Tarjeta Principal */
    .transfer-card {
      background: var(--glass);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(0, 243, 255, 0.2);
      box-shadow: 0 0 30px rgba(0, 243, 255, 0.1);
      transition: all 0.3s ease;
    }
    
    .glow-text { text-shadow: 0 0 10px rgba(0, 243, 255, 0.7); }
    .glow-border:focus-within {
      border-color: var(--neon-cyan);
      box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
    }

    /* Input personalizado */
    .cyber-input {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid #333;
      font-family: 'Orbitron', sans-serif;
      transition: 0.3s;
    }
    .cyber-input:focus {
      border-color: var(--neon-pink);
      outline: none;
      box-shadow: 0 0 10px rgba(255, 0, 255, 0.3);
    }

    /* Lista de usuarios */
    .user-item {
      transition: 0.2s;
      cursor: pointer;
      border-left: 3px solid transparent;
    }
    .user-item:hover {
      background: rgba(255, 255, 255, 0.05);
      border-left-color: var(--neon-cyan);
      padding-left: 1rem;
    }
    .user-item.selected {
      background: linear-gradient(90deg, rgba(0, 243, 255, 0.15), transparent);
      border-left-color: var(--neon-green);
      border: 1px solid var(--neon-cyan);
    }

    /* Botón animado */
    .btn-transfer {
      background: linear-gradient(45deg, #0066ff, #00f3ff);
      position: relative;
      overflow: hidden;
      transition: 0.3s;
    }
    .btn-transfer:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 25px rgba(0, 243, 255, 0.6);
    }
    .btn-transfer::after {
      content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      transition: 0.5s;
    }
    .btn-transfer:hover::after { left: 100%; }
    .btn-transfer:disabled { filter: grayscale(1); cursor: not-allowed; }

    /* Overlay de Carga */
    #loadingOverlay {
      backdrop-filter: blur(20px);
      background: rgba(0,0,0,0.85);
    }
    
    .scanner-line {
      height: 2px; width: 100%; background: var(--neon-green);
      position: absolute; top: 0;
      animation: scan 2s infinite linear;
      box-shadow: 0 0 10px var(--neon-green);
    }
    @keyframes scan {
      0% { top: 0%; opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { top: 100%; opacity: 0; }
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0f0812; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--neon-cyan); }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

  <canvas id="particles"></canvas>
  
  <a href="dashboard.html" class="fixed top-5 left-5 z-50 flex items-center gap-2 text-gray-400 hover:text-white transition group">
    <div class="p-2 rounded-full border border-gray-600 group-hover:border-white transition">
      <i class="fas fa-arrow-left"></i>
    </div>
    <span class="font-bold text-sm">VOLVER AL DASHBOARD</span>
  </a>

  <main class="w-full max-w-lg relative z-10">
    
    <div class="transfer-card rounded-2xl p-6 mb-6 text-center relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-cyan-400 to-purple-500"></div>
        <h2 class="text-gray-400 text-sm tracking-[0.2em] uppercase mb-1">Tu Saldo Disponible</h2>
        <div class="text-4xl md:text-5xl font-bold font-orbitron glow-text text-white">
            $<span id="myBalanceDisplay">0.00</span>
        </div>
        <div class="mt-2 text-xs text-green-400 flex justify-center items-center gap-1">
            <i class="fas fa-check-circle"></i> Sincronizado
        </div>
    </div>

    <div class="transfer-card rounded-2xl p-6 md:p-8">
      
      <h1 class="text-2xl font-bold mb-6 flex items-center gap-2 text-neon-cyan">
        <i class="fas fa-paper-plane"></i> TRANSFERENCIA
      </h1>

      <div class="mb-6 relative">
        <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">1. Buscar Destinatario</label>
        <div class="relative">
            <input type="text" id="userSearchInput" placeholder="Escribe nombre o email..." 
                class="w-full cyber-input rounded-lg p-4 pl-12 text-white placeholder-gray-600 focus:placeholder-gray-400">
            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500"></i>
        </div>
        
        <div id="usersListContainer" class="hidden absolute top-full left-0 w-full bg-[#141225] border border-gray-700 rounded-lg max-h-48 overflow-y-auto z-50 shadow-2xl mt-2">
            </div>

        <div id="selectedUserCard" class="hidden mt-3 p-3 bg-blue-900/30 border border-blue-500/50 rounded-lg flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center font-bold text-white text-lg">
                    <span id="selUserInitial">U</span>
                </div>
                <div>
                    <div class="text-sm text-gray-300">Enviando a:</div>
                    <div id="selUserName" class="font-bold text-white text-lg leading-none">Usuario</div>
                </div>
            </div>
            <button id="cancelSelectionBtn" class="text-red-400 hover:text-red-300"><i class="fas fa-times"></i></button>
        </div>
      </div>

      <div class="mb-8 opacity-50 pointer-events-none transition-all duration-300" id="amountSection">
        <label class="block text-xs font-bold text-gray-400 mb-2 uppercase flex justify-between">
            <span>2. Monto a enviar</span>
            <span class="text-neon-pink text-[10px]">FEE: $0.05 USD</span>
        </label>
        <div class="relative">
            <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-2xl text-gray-500 font-bold">$</span>
            <input type="number" id="amountInput" placeholder="0.00" step="0.01"
                class="w-full cyber-input rounded-lg p-4 pl-10 text-2xl font-bold text-white placeholder-gray-700">
            <button id="btnMax" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-xs bg-gray-700 hover:bg-gray-600 text-cyan-300 px-2 py-1 rounded">MAX</button>
        </div>
        
        <div class="mt-3 flex justify-between text-sm border-t border-white/10 pt-2">
            <span class="text-gray-400">Comisión de red:</span>
            <span class="text-red-400 font-mono">-$0.05</span>
        </div>
        <div class="flex justify-between text-sm font-bold">
            <span class="text-gray-300">Total a descontar:</span>
            <span id="totalDeduction" class="text-neon-green font-mono">$0.00</span>
        </div>
        <div id="insufficientFundsMsg" class="hidden text-center text-red-500 text-xs font-bold mt-2 animate-pulse">
            ⚠️ SALDO INSUFICIENTE PARA CUBRIR EL ENVÍO + COMISIÓN
        </div>
      </div>

      <button id="btnConfirmTransfer" disabled 
        class="w-full btn-transfer text-white font-bold py-4 rounded-xl text-lg shadow-[0_0_20px_rgba(0,243,255,0.3)] tracking-widest uppercase">
        Procesar Envío
      </button>

    </div>
  </main>

  <div id="loadingOverlay" class="fixed inset-0 z-[100] hidden flex-col items-center justify-center text-white">
    <div class="w-64 h-64 relative border border-cyan-500/30 bg-black/50 rounded-lg overflow-hidden flex items-center justify-center mb-4">
        <div class="scanner-line"></div>
        <div class="text-center">
            <i class="fas fa-fingerprint text-6xl text-cyan-500 animate-pulse mb-4"></i>
            <div class="text-xl font-mono text-cyan-300">VERIFICANDO</div>
        </div>
    </div>
    <div id="loadingText" class="font-mono text-green-400 tracking-widest">INICIANDO CONTRATO...</div>
  </div>

  <script>
    // --- LÓGICA DE PARTÍCULAS (IDÉNTICA A TU SCRIPT ORIGINAL) ---
    (function(){
      const canvas = document.getElementById('particles');
      const ctx = canvas.getContext('2d');
      let w = canvas.width = innerWidth;
      let h = canvas.height = innerHeight;
      const colors = ['rgba(0,240,255,0.5)', 'rgba(255,77,240,0.5)'];
      const particles = [];
      const PARTICLE_COUNT = 40; 
      function rand(min,max){return Math.random()*(max-min)+min;}
      function makeParticle(){
        return {x:rand(0,w),y:rand(0,h),vx:rand(-0.5,0.5),vy:rand(-0.5,0.5),r:rand(1,3),hue:colors[Math.floor(Math.random()*colors.length)]};
      }
      for(let i=0;i<PARTICLE_COUNT;i++) particles.push(makeParticle());
      window.addEventListener('resize', ()=>{w=canvas.width=innerWidth;h=canvas.height=innerHeight;});
      function draw(){
        ctx.clearRect(0,0,w,h);
        for(let p of particles){
          p.x+=p.vx; p.y+=p.vy;
          if(p.x<0)p.x=w; if(p.x>w)p.x=0;
          if(p.y<0)p.y=h; if(p.y>h)p.y=0;
          ctx.beginPath(); ctx.fillStyle=p.hue; ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
        }
        requestAnimationFrame(draw);
      }
      draw();
    })();

    // --- CONFIGURACIÓN FIREBASE (MISMOS DATOS) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCr1-2dIqgxoXBTKYgSusnUZorUICX2Too",
      authDomain: "chatglobal-e9370.firebaseapp.com",
      databaseURL: "https://chatglobal-e9370-default-rtdb.firebaseio.com",
      projectId: "chatglobal-e9370",
      storageBucket: "chatglobal-e9370.firebasestorage.app",
      messagingSenderId: "382420208590",
      appId: "1:382420208590:web:9425fa28c8cdf669adb99f"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- LÓGICA DE NEGOCIO ---
    document.addEventListener("DOMContentLoaded", () => {
        const currentUserEmail = sessionStorage.getItem("sociosxit_user");
        
        // Redirigir si no hay sesión
        if (!currentUserEmail) {
            window.location.href = "index.html";
            return;
        }

        const sanitizeEmail = (email) => email.replace(/\./g, "_");
        const myKey = sanitizeEmail(currentUserEmail);
        
        // Elementos DOM
        const balanceDisplay = document.getElementById("myBalanceDisplay");
        const userSearchInput = document.getElementById("userSearchInput");
        const usersListContainer = document.getElementById("usersListContainer");
        const selectedUserCard = document.getElementById("selectedUserCard");
        const selUserName = document.getElementById("selUserName");
        const selUserInitial = document.getElementById("selUserInitial");
        const cancelSelectionBtn = document.getElementById("cancelSelectionBtn");
        const amountSection = document.getElementById("amountSection");
        const amountInput = document.getElementById("amountInput");
        const btnMax = document.getElementById("btnMax");
        const totalDeductionEl = document.getElementById("totalDeduction");
        const insufficientMsg = document.getElementById("insufficientFundsMsg");
        const btnConfirm = document.getElementById("btnConfirmTransfer");
        
        const loadingOverlay = document.getElementById("loadingOverlay");
        const loadingText = document.getElementById("loadingText");

        let myCurrentBalance = 0.00;
        let selectedRecipientKey = null;
        let selectedRecipientName = "";
        const TRANSACTION_FEE = 0.05;

        // 1. Obtener mi saldo en tiempo real
        db.ref(`users/${myKey}/balance`).on("value", snapshot => {
            myCurrentBalance = parseFloat(snapshot.val() || 0);
            balanceDisplay.textContent = myCurrentBalance.toFixed(2);
            validateAmount(); // Re-validar si cambia el saldo
        });

        // 2. Buscar Usuarios
        userSearchInput.addEventListener("input", (e) => {
            const query = e.target.value.toLowerCase().trim();
            if (query.length < 2) {
                usersListContainer.classList.add("hidden");
                return;
            }

            db.ref("users").once("value").then(snapshot => {
                usersListContainer.innerHTML = "";
                let hasResults = false;
                
                snapshot.forEach(child => {
                    const userKey = child.key;
                    // No mostrarme a mí mismo
                    if (userKey === myKey) return;

                    const userData = child.val();
                    const email = userData.email || userKey;
                    // Búsqueda simple por email o clave
                    if (email.toLowerCase().includes(query) || userKey.toLowerCase().includes(query)) {
                        hasResults = true;
                        
                        const div = document.createElement("div");
                        div.className = "user-item p-3 flex items-center gap-3 border-b border-gray-800";
                        div.innerHTML = `
                            <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-xs font-bold text-white">
                                ${email.charAt(0).toUpperCase()}
                            </div>
                            <div class="flex-1">
                                <div class="text-sm font-bold text-cyan-100">${email}</div>
                                <div class="text-[10px] text-gray-500">ID: ${userKey.substring(0,10)}...</div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-600 text-xs"></i>
                        `;
                        div.onclick = () => selectUser(userKey, email);
                        usersListContainer.appendChild(div);
                    }
                });

                if (hasResults) usersListContainer.classList.remove("hidden");
                else usersListContainer.classList.add("hidden");
            });
        });

        // Seleccionar usuario
        function selectUser(key, name) {
            selectedRecipientKey = key;
            selectedRecipientName = name;
            
            userSearchInput.value = "";
            usersListContainer.classList.add("hidden");
            userSearchInput.parentElement.classList.add("hidden"); // Ocultar buscador
            
            // Mostrar tarjeta de seleccionado
            selectedUserCard.classList.remove("hidden");
            selUserName.textContent = name;
            selUserInitial.textContent = name.charAt(0).toUpperCase();

            // Activar sección de monto
            amountSection.classList.remove("opacity-50", "pointer-events-none");
            amountInput.focus();
        }

        // Cancelar selección
        cancelSelectionBtn.onclick = () => {
            selectedRecipientKey = null;
            selectedRecipientName = "";
            selectedUserCard.classList.add("hidden");
            userSearchInput.parentElement.classList.remove("hidden");
            amountSection.classList.add("opacity-50", "pointer-events-none");
            amountInput.value = "";
            validateAmount();
        };

        // 3. Validación de Monto y Fee
        function validateAmount() {
            const amount = parseFloat(amountInput.value);
            
            if (isNaN(amount) || amount <= 0) {
                totalDeductionEl.textContent = "$0.00";
                btnConfirm.disabled = true;
                insufficientMsg.classList.add("hidden");
                return;
            }

            const totalNeeded = amount + TRANSACTION_FEE;
            totalDeductionEl.textContent = `$${totalNeeded.toFixed(2)}`;

            if (totalNeeded > myCurrentBalance) {
                insufficientMsg.classList.remove("hidden");
                btnConfirm.disabled = true;
            } else {
                insufficientMsg.classList.add("hidden");
                btnConfirm.disabled = false;
            }
        }

        amountInput.addEventListener("input", validateAmount);

        // Botón MAX
        btnMax.onclick = () => {
            // Calcula cuánto puede enviar para que (Monto + 0.05) <= Saldo
            // Monto = Saldo - 0.05
            let maxSendable = myCurrentBalance - TRANSACTION_FEE;
            if (maxSendable < 0) maxSendable = 0;
            
            amountInput.value = maxSendable.toFixed(2);
            validateAmount();
        };

        // 4. PROCESAR TRANSFERENCIA
        btnConfirm.onclick = async () => {
            const amount = parseFloat(amountInput.value);
            const totalNeeded = amount + TRANSACTION_FEE;

            if (!selectedRecipientKey || isNaN(amount) || totalNeeded > myCurrentBalance) return;

            // Iniciar animación
            loadingOverlay.classList.remove("hidden");
            loadingOverlay.style.display = "flex";
            
            // Simular tiempos de proceso (Animación visual)
            const steps = [
                { t: 500, txt: "ENCRIPTANDO SOLICITUD..." },
                { t: 1500, txt: "VERIFICANDO FONDOS..." },
                { t: 2500, txt: "CONFIRMANDO DESTINATARIO..." },
                { t: 3500, txt: "EJECUTANDO TRANSFERENCIA..." }
            ];

            for (let step of steps) {
                setTimeout(() => { loadingText.textContent = step.txt; }, step.t);
            }

            // Ejecución real en Firebase (Esperamos 4 segundos para el efecto)
            setTimeout(async () => {
                try {
                    // Validar una última vez el saldo en servidor (o snapshot reciente)
                    const mySnap = await db.ref(`users/${myKey}/balance`).once("value");
                    const currentBal = parseFloat(mySnap.val() || 0);

                    if (currentBal < totalNeeded) {
                        throw new Error("Saldo insuficiente durante la transacción.");
                    }

                    const updates = {};
                    
                    // Restar a mí (Monto + Fee)
                    const newMyBalance = Number((currentBal - totalNeeded).toFixed(2));
                    updates[`users/${myKey}/balance`] = newMyBalance;

                    // Sumar a destinatario (Solo el monto)
                    // Primero leemos el saldo actual del destinatario
                    const destSnap = await db.ref(`users/${selectedRecipientKey}/balance`).once("value");
                    const destBal = parseFloat(destSnap.val() || 0);
                    const newDestBalance = Number((destBal + amount).toFixed(2));
                    
                    updates[`users/${selectedRecipientKey}/balance`] = newDestBalance;

                    // Opcional: Guardar historial (Recomendado pero no pedido explícitamente, lo hacemos simple)
                    // updates[`transfers/${Date.now()}`] = { from: myKey, to: selectedRecipientKey, amount: amount, fee: TRANSACTION_FEE };

                    await db.ref().update(updates);

                    // ÉXITO
                    loadingText.textContent = "¡TRANSACCIÓN COMPLETADA!";
                    loadingText.classList.remove("text-green-400");
                    loadingText.classList.add("text-neon-cyan");
                    
                    await Swal.fire({
                        icon: 'success',
                        title: '¡Envío Exitoso!',
                        html: `Has enviado <b>$${amount.toFixed(2)}</b> a ${selectedRecipientName}.<br>Tu nuevo saldo: $${newMyBalance.toFixed(2)}`,
                        background: '#141225',
                        color: '#fff',
                        confirmButtonColor: '#00f3ff',
                        timer: 4000,
                        timerProgressBar: true
                    });

                    window.location.reload(); // Reiniciar página como solicitado

                } catch (error) {
                    console.error(error);
                    loadingOverlay.classList.add("hidden");
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo completar la transferencia. Intenta de nuevo.',
                        background: '#141225',
                        color: '#fff'
                    });
                }
            }, 4000);
        };
    });
  </script>
</body>
</html>
